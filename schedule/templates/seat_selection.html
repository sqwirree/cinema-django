{% extends 'base.html' %}
{% block title %}–í–∏–±—ñ—Ä –º—ñ—Å—Ü—å{% endblock %}

{% block extra_css %}
<style>
/* –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–±–æ—Ä–∞ –º–µ—Å—Ç */
.seat-page {
  min-height: calc(100vh - 80px);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px 10px 40px 10px;
}

/* –ü–µ—Ä–µ–∫—Ä—ã–≤–∞–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –ø–æ–¥ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É */
body {
  text-align: center;
  /* –í–ê–ñ–ù–û: –Ω–µ –ø—Ä—è—á–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
  overflow-x: visible;
}

/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
.seat-title {
  margin: 20px 0 16px;
  color: #ffcc00;
  font-size: 2rem;
}

/* –ï–∫—Ä–∞–Ω */
.screen {
  background: linear-gradient(to bottom, #ccc, #999);
  height: 40px;
  width: 80%;
  max-width: 700px;
  margin: 0 auto 50px;
  border-radius: 0 0 100% 100%;
  box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
}

/* –û–±—ë—Ä—Ç–∫–∞ –∑–∞–ª–∞ ‚Äî –¥–∞—ë–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ */
.hall-wrapper {
  width: 100%;
  max-width: 100%;
  overflow-x: auto;
  padding-bottom: 10px;
}

/* –ó–∞–ª */
.hall {
  display: inline-block;
  padding: 20px 30px;
  background: rgba(20, 20, 20, 0.95);
  border-radius: 10px;
  box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
  position: relative; /* –±–∞–∑–∞ –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ª—é–¥–µ–π */
}

/* –û–±–µ—Ä—Ç–∫–∞ —Ä—è–¥–∞ —Å –ø–æ–¥–ø–∏—Å—å—é */
.row-wrapper {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  position: relative;
}

/* –ü–æ–¥–ø–∏—Å—å —Ä—è–¥–∞ */
.row-label {
  width: 60px;
  text-align: right;
  margin-right: 12px;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.35);
  user-select: none;
  pointer-events: none;
}

/* –†—è–¥ –∫—Ä–µ—Å–µ–ª */
.row {
  display: flex;
  justify-content: center;
  margin-bottom: 8px;
}

/* –ö—Ä–µ—Å–ª–æ */
.seat {
  width: 28px;
  height: 28px;
  margin: 10px 6px;
  border-radius: 5px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  cursor: pointer;
  border: none;
  text-decoration: none;
  position: relative;
}

/* –í—ñ–ª—å–Ω–µ / –∑–∞–π–Ω—è—Ç–µ */
.free {
  background-color: #1e1e1e;
  box-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
}
.reserved {
  background-color: #444;
  cursor: not-allowed;
}

/* –ß–µ–ª–æ–≤–µ—á–∫–∏-—à–∞—Ä–∏–∫–∏ */
.person {
  position: absolute;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #ffffff, #ffcc00 45%, #ff6600 100%);
  box-shadow: 0 0 8px rgba(255, 204, 0, 0.9);
  pointer-events: none;
  opacity: 0.9;
  left: 0;  /* (0,0) = –≤–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π —É–≥–æ–ª .hall */
  top: 0;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ üì± –ê–î–ê–ü–¢–ò–í ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

/* –¢–µ–ª–µ—Ñ–æ–Ω—ã */
@media (max-width: 600px) {
  .seat-page {
    padding: 10px 6px 30px 6px;
  }

  .seat-title {
    font-size: 1.6rem;
    margin: 16px 0 12px;
  }

  .screen {
    width: 90%;
    margin-bottom: 30px;
    height: 32px;
  }

  .hall-wrapper {
    /* —á—É—Ç—å –º–µ–Ω—å—à–µ –±–æ–∫–æ–≤—ã–µ –ø–∞–¥–¥–∏–Ω–≥–∏, —á—Ç–æ–±—ã –∑–∞–ª –≤–ª–µ–∑–∞–ª */
    padding-bottom: 8px;
  }

  .hall {
    padding: 14px 10px;
  }

  .row-wrapper {
    margin-bottom: 6px;
  }

  .row-label {
    width: 48px;
    margin-right: 6px;
    font-size: 12px;
  }

  .seat {
    width: 22px;
    height: 22px;
    margin: 6px 4px;
    font-size: 10px;
  }

  .person {
    width: 14px;
    height: 14px;
  }
}

/* –ü–ª–∞–Ω—à–µ—Ç—ã */
@media (min-width: 601px) and (max-width: 991px) {
  .seat-page {
    padding: 20px 10px 35px;
  }

  .screen {
    width: 85%;
    margin-bottom: 40px;
  }

  .hall {
    padding: 18px 18px;
  }
}

/* –î–µ—Å–∫—Ç–æ–ø—ã */
@media (min-width: 992px) {
  .seat-page {
    padding-top: 30px;
  }

  .hall {
    padding: 22px 32px;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="seat-page">
  <h1 class="seat-title">–í–∏–±—ñ—Ä –º—ñ—Å—Ü—å –Ω–∞ "{{ session.movie.title }}"</h1>

  <div class="screen"></div>

  <div class="hall-wrapper">
    <div class="hall" id="hall">
      {% for row in seat_rows %}
        <div class="row-wrapper">
          <div class="row-label">–†—è–¥ {{ forloop.counter }}</div>
          <div class="row">
            {% for seat in row %}
              {% if seat.is_reserved %}
                <a href="{% url 'profile' seat.viewer.id %}" class="seat reserved" title="–ó–∞–π–Ω—è—Ç–æ">
                  {{ seat.column }}
                </a>
              {% else %}
                <a href="{% url 'confirm_ticket' seat.id %}" class="seat free" title="–í—ñ–ª—å–Ω–æ">
                  {{ seat.column }}
                </a>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  // –ê–Ω–∏–º–∞—Ü–∏—è –ª—é–¥–µ–π: –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç–æ—á–∫–µ -> –∑–∞—Ö–æ–¥—è—Ç –≤ –∑–∞–ª -> –∏–¥—É—Ç -> —Å–∏–¥—è—Ç -> —É—Ö–æ–¥—è—Ç —Ç–µ–º –∂–µ –ø—É—Ç—ë–º -> –∏—Å—á–µ–∑–∞—é—Ç
  document.addEventListener('DOMContentLoaded', function () {
    const hall = document.getElementById('hall');
    if (!hall) return;

    const hallRect = hall.getBoundingClientRect();
    const reservedSeats = hall.querySelectorAll('.seat.reserved');

    // –û–î–ù–ê –æ–±—â–∞—è –¥–≤–µ—Ä—å –¥–ª—è –≤—Å–µ—Ö
    const entranceXOutside = hallRect.width + 40;   // –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –∑–∞–ª–∞
    const entranceXInside  = hallRect.width - 10;   // –≤–Ω—É—Ç—Ä–∏ –∑–∞–ª–∞, —É –¥–≤–µ—Ä–∏
    const entranceY        = hallRect.height * 0.5; // —Å–µ—Ä–µ–¥–∏–Ω–∞ –ø–æ –≤—ã—Å–æ—Ç–µ

    function runCycle(seat) {
      const seatRect = seat.getBoundingClientRect();

      const seatX = seatRect.left - hallRect.left - 8 + seatRect.width / 2;
      const seatY = seatRect.top  - hallRect.top  - 8 + seatRect.height / 2;

      const midY = seatY - 35; // –ø—Ä–æ—Ö–æ–¥ –Ω–∞–¥ —Ä—è–¥–æ–º

      const totalDuration = 7000 + Math.random() * 5000; // 7‚Äì12 —Å–µ–∫

      // –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏
      const oEnterStepX   = 0.08; // –∏–∑-–∑–∞ —Å—Ç–µ–Ω—ã –≤ –∑–∞–ª
      const oDownToRow    = 0.22; // –≤–Ω–∏–∑ –∫ —É—Ä–æ–≤–Ω—é —Ä—è–¥–∞
      const oAlongRow     = 0.38; // –ø–æ —Ä—è–¥—É –∫ –º–µ—Å—Ç—É
      const oSitDown      = 0.48; // —Å–µ–ª
      const oSitHold      = 0.68; // –ø–æ—Å–∏–¥–µ–ª
      const oUpFromSeat   = 0.80; // –≤–≤–µ—Ä—Ö –∫ –ø—Ä–æ—Ö–æ–¥—É (seatX, midY)
      const oBackAlongRow = 0.92; // –ø–æ —Ä—è–¥—É –Ω–∞–∑–∞–¥ –∫ –¥–≤–µ—Ä–∏ (entranceXInside, midY)
      const oUpToDoor     = 0.96; // –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑ –∫ —É—Ä–æ–≤–Ω—é –¥–≤–µ—Ä–∏ (entranceXInside, entranceY)
      const oEnd          = 1.00; // –≤—ã—Ö–æ–¥ –∑–∞ –¥–≤–µ—Ä—å (entranceXOutside, entranceY)

      const person = document.createElement('div');
      person.classList.add('person');
      hall.appendChild(person);

      const animation = person.animate(
        [
          { transform: `translate(${entranceXOutside}px, ${entranceY}px) scale(1)`, offset: 0 },
          { transform: `translate(${entranceXInside}px, ${entranceY}px) scale(1)`, offset: oEnterStepX },
          { transform: `translate(${entranceXInside}px, ${midY}px) scale(1)`, offset: oDownToRow },
          { transform: `translate(${seatX}px, ${midY}px) scale(1)`, offset: oAlongRow },
          { transform: `translate(${seatX}px, ${seatY}px) scale(1.1, 0.9)`, offset: oSitDown },
          { transform: `translate(${seatX}px, ${seatY}px) scale(0.95, 1.05)`, offset: oSitHold },
          { transform: `translate(${seatX}px, ${midY}px) scale(1)`, offset: oUpFromSeat },
          { transform: `translate(${entranceXInside}px, ${midY}px) scale(1)`, offset: oBackAlongRow },
          { transform: `translate(${entranceXInside}px, ${entranceY}px) scale(1)`, offset: oUpToDoor },
          { transform: `translate(${entranceXOutside}px, ${entranceY}px) scale(1)`, offset: oEnd },
        ],
        {
          duration: totalDuration,
          iterations: 1,
          easing: 'ease-in-out'
        }
      );

      animation.onfinish = () => {
        person.remove();
        const pause = 1500 + Math.random() * 5000; // 1.5‚Äì6.5 —Å–µ–∫ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ
        setTimeout(() => runCycle(seat), pause);
      };
    }

    reservedSeats.forEach((seat) => {
      const initialDelay = 500 + Math.random() * 4000;
      setTimeout(() => runCycle(seat), initialDelay);
    });
  });
</script>
{% endblock %}
